# Получение и разбор данных
## Получение архива с дампом адресов
```php artisan gar:load date --full --parse --region=```

Где:
1.  `date (default=latest)` - дата выгрузки на сайте [fias.nalog.ru](https://fias.nalog.ru). Данные есть не на все даты. Базово загружает самую свежую.
2.  `--full` - если установлен этот флаг, то будет загружен весь архив (40gb+). Без него будет загружена только изменения от последней выгрузки.
3.  `--parse` - если установлен этот флаг, то после загрузки архива будет запущен разбор данных из него.
4.  `--region= (default=null)` - регион, данные которого разобрать в скачанном архиве. Используется только при наличии флага `--parse`. Указывается в виде номера региона из двух знаков, например для Москвы будет `77`, для Башкортостана - `02`. Базово разбирает все регионы.

Архив будет сохранён в папке `storage\app\gar\{date}` с именем `arch_full.zip` при запросе полной выгрузки и `arch.zip` при загрузке изменений.

## Парсинг полученных данных  

Все команды для парсинга полученных данных находятся в пространстве имён `gar:parse`.  

Для разбора всего архива одной командой существует  
```php artisan gar:parse path --region=```

Где:
1.  `path` - путь до архива с данными внутри папки `storage\app\gar\` вида "дата\имя архива". Пример: `2023.07.26\arch.zip`.
2.  `--region= (default=null)` - указание на то, с какого региона брать данные.

Также можно вызвать разбор конкретного типа файлов (наример, только дома)  

```php artisan gar:parse:<command name> path --region=```

Где:
1.  `<command name>` - имя команды. Полный список можно получить выполнив `php artisan list`.
2.  `path` - путь до архива с данными внутри папки `storage\app\gar\` вида "дата\имя архива". Пример: `2023.07.26\arch.zip`.
3.  `--region= (default=null)` - указание на то, с какого региона брать данные.

# Работа с полученными данными
**Для сохранения адреса в виде строки и дальнейшего поиска по строке в проекте используется elasticsearch. Для корректной работы описываемых далее действий требуется настроить подключение.**
Для этого в `.env` необходимо описать следующией переменные:
1. `ELASTIC_USER` - пользователь elastic.
2. `ELASTIC_PASS` - пароль пользователя elastic.
3. `ELASTIC_HOST` - хост, на котором находится elastic
4. `ELASTIC_PORT` - порт

## Сбор полной строки адреса

В самих данных не поставляется полный адрес для элемента адреса, но есть его муниципальная и административная иерархия (цепочка родителей). Для получения полной адресной строки для всех элементов в базе (квартиры, строения, адресные объекты) существует следующая команда:

```php artisan gar:address-str date --all```

Где:
1.  `date` - дата обновления объектов от которой нужно собрать адреса. Например, при передаче даты "26.07.2023 12:34:56" будут пересчитаны только те записи, что были обновлены между указанной и текущей датой.
2.  `--all` - опционально. Если был передан, то будет обновлена вся база.

## Поиск по собранным данным

Для запуска поиска существует эндпоинт `/api/search?q=`. В параметр `q` следует передать строку для поиска.

Дополнительные параметры:
1.  `page` - номер страницы. Начинается с 1.
2.  `filters[exclude_levels]` - массив с уровнями объектов, которые следует исключить из выдачи.
3.  `filters[is_active]` - булевый параметр, указывающий на поиск только активных/неактивных записи.